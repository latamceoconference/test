## LensStore (Brasil) — 렌즈 쇼핑몰 (Pix / Cartão)

이 프로젝트는 브라질 결제 환경(**Pix / Cartão**)을 전제로 한 Next.js(앱 라우터 + TS + Tailwind) 기반 렌즈 쇼핑몰입니다.  
렌즈 쇼핑몰에서 가장 중요한 **도수 선택(SPH) UX**를 핵심으로 설계했고, **Supabase(Postgres + Storage)** 를 통해 “상품/옵션/주문”을 운영할 수 있는 구조까지 구현되어 있습니다.

> 화면(UI)은 pt-BR(포르투갈어)로 되어 있고, 이 README는 사용자가 전체 상태를 이해하기 쉽게 **한글로** 작성했습니다.

---

## 1) 지금 “되어 있는 것” 요약(현재 구현 범위)

### 1-1. 고객 화면(프론트)
- **홈(`/`)**: 히어로 + 추천(상품 3개)
- **상품 목록(`/products`)**
  - 검색(브랜드/상품명)
  - 카테고리 필터
  - 가격 정렬
- **상품 상세(`/products/[id]`)**
  - **SPH(도수) 선택(버튼 그리드)**
  - SPH 선택 전에는 “장바구니 담기” 버튼 비활성화(실수 방지)
- **장바구니(`/cart`)**
  - 수량 변경/삭제
  - 합계 계산
  - 체크아웃 이동
- **체크아웃(`/checkout`)**
  - 이름/이메일/CPF/전화/CEP/주소 입력
  - 결제 클릭 시 서버로 요청 → 결제 세션 생성 → 리다이렉트
- **결제 결과(`/checkout/result`)**
  - 모드(mock/mercadopago), status, payment_id, order_id 표시
- **정책 페이지(템플릿)**
  - `/policies/terms`, `/policies/privacy`, `/policies/shipping`, `/policies/returns`

### 1-2. 상태관리/데이터 구조(중요)
- **장바구니(zustand + localStorage)**: `src/store/cart.ts`
  - 단순히 productId만 저장하는 게 아니라, **title/price/image/sph 등 “스냅샷”을 저장**합니다.
  - 이 방식은 상용화에서 중요합니다:
    - 장바구니 화면이 DB 호출에 의존하지 않음(빠름/안정적)
    - 상품 가격/이미지가 바뀌어도 “장바구니 시점의 정보”를 유지 가능(정책에 따라 조정 가능)

### 1-3. 서버(API) + 결제 + 주문
- **주문 생성 + 결제 세션 생성**: `POST /api/checkout/create-preference`
  - Supabase에 `orders`, `order_items`를 먼저 생성
  - Mercado Pago preference 생성 시:
    - `external_reference = orderId`로 연결
    - `notification_url = /api/mercadopago/webhook` 지정
- **결제 웹훅**: `POST /api/mercadopago/webhook`
  - Mercado Pago payment 조회 → `orders.status` 업데이트
  - (현재는 “기본 동작” 구현, 추후 서명검증/중복처리/로그 강화 추천)

---

## 2) 프로젝트 실행 방법(로컬) — 아주 자세히

### 2-1. 필수 설치
- Node.js 권장: 20+
- npm

### 2-2. 설치/실행(Windows PowerShell)

```powershell
$desktop=[Environment]::GetFolderPath('Desktop')
cd -LiteralPath (Join-Path (Join-Path $desktop 'Shopping') 'lensstore')
npm install
npm run dev
```

접속:
- `http://localhost:4000`

---

## 3) Supabase 연결 방법(가장 중요 — 매우 자세히)

### 3-1. Supabase 프로젝트 생성
1) Supabase에서 New project 생성  
2) Region 선택(브라질 타겟이면 SA 쪽 고려)  
3) 생성 후 Project Settings → API에서 아래 2개를 확인:
   - **Project URL** → `NEXT_PUBLIC_SUPABASE_URL`
   - **anon public key** → `NEXT_PUBLIC_SUPABASE_ANON_KEY`
4) Project Settings → API에서 **service_role key** 확인:
   - `SUPABASE_SERVICE_ROLE_KEY`
   - **주의**: 이 키는 “서버 전용”입니다. 브라우저에 절대 노출하면 안 됩니다.

### 3-2. DB 스키마 적용(필수)
Supabase → SQL Editor에서 아래 순서로 실행하세요:
1) `supabase/schema.sql`
2) (선택) `supabase/seed.sql`  
   - 샘플 상품/옵션을 넣어 바로 화면 확인할 수 있습니다.
3) (중요) 재고 차감/복구 함수 적용:
   - `supabase/functions.sql`
4) (회원 기능) 프로필 테이블/트리거 적용:
   - `supabase/auth_profiles.sql`
5) (마이페이지 주문내역) 로그인 유저와 주문 연결 + RLS:
   - `supabase/orders_auth.sql`

### 3-3. `.env.local` 만들기(필수)
1) `lensstore/env.example` 파일을 복사해서 `lensstore/.env.local` 생성
2) 아래 값을 채웁니다:
- `NEXT_PUBLIC_SITE_URL=http://localhost:4000`
- `NEXT_PUBLIC_SUPABASE_URL=...`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY=...`
- `SUPABASE_SERVICE_ROLE_KEY=...`
- (선택) `MERCADOPAGO_ACCESS_TOKEN=...`

> `.env.local` 수정 후에는 반드시 서버를 재시작하세요. (`Ctrl+C` → `npm run dev`)

### 3-4. Supabase가 “연결된 상태”인지 확인하는 법
1) 서버 재시작 후 `/products`로 이동
2) seed를 넣었다면 seed 상품이 표시됩니다.

코드 흐름:
- `src/lib/catalog.ts`가 환경변수를 확인합니다.
  - Supabase env가 있으면: Supabase에서 `products`, `product_variants`를 읽습니다.
  - 없으면: 로컬 `src/lib/products.ts` 데이터로 폴백합니다.

### 3-5. “재고가 실시간으로 변하는지” 확인(Realtime)
실시간 재고 반영은 Supabase Realtime을 사용합니다.

1) Supabase 대시보드에서 Realtime 설정을 확인/활성화합니다.
2) 테이블 `product_variants`에 대해 Realtime이 켜져 있어야 합니다.
3) 브라우저를 2개 띄운 다음:
   - 한쪽에서 체크아웃(주문 생성) → 재고가 감소
   - 다른 쪽 상품 상세 페이지의 SPH 재고 표시가 **새로고침 없이** 변하면 성공

코드 위치:
- `src/components/product-detail-buy-box.tsx` (product_variants 변경을 구독)

---

## 4) 내가 앞으로 “어디를 어떻게 고치면 되는지”

### 4-1. 상품/옵션(도수) 운영(상용 필수)
현재는 2가지 경로가 있습니다.

#### A) Supabase DB로 운영(추천)
- `products` 테이블에서 상품 기본정보 관리
- `product_variants`에서 SPH별 가격/재고/sku 운영

#### B) 로컬 파일로 운영(비추천, 개발용)
- `src/lib/products.ts` 직접 수정

### 4-2. 이미지 운영(상용 필수)
현재는 `image_url`이 `/file.svg` 같은 로컬 리소스를 가리킵니다.

상용 운영 추천:
1) Supabase Storage에 버킷 생성(예: `product-images`)
2) 업로드 규칙:
   - `products/{productId}/cover.webp`
3) `products.image_url`에 public URL(또는 path)을 저장
4) Next 이미지 최적화를 쓰려면:
   - `next.config.ts`에 Supabase 도메인 `images.remotePatterns` 추가 필요

### 4-3. 결제/주문(상용 필수 강화 포인트)
현재 동작은 “주문 생성 → preference 생성 → 웹훅으로 상태 업데이트”까지 구현되어 있습니다.

상용 수준으로 강화하려면 다음이 필요합니다:
- **웹훅 보안/안정성**
  - 서명/검증(가능한 범위)
  - 중복 이벤트(idempotency) 처리
  - 실패 재시도 대비 로깅/큐
- **재고 차감 정책**
  - 결제 승인 시 차감 vs 주문 생성 시 예약(락)
- **주문 상세 화면(관리자/고객)**
  - 주문 조회/상태 페이지

---

## 5) 테스트 방법(정말 제대로)

### 5-1. “빠른 기능 테스트”(Mercado Pago 토큰 없이)
목표: 상품→장바구니→체크아웃→결과 페이지까지 흐름 확인
1) `/products`에서 상품 선택 → SPH 선택 → 장바구니 담기
2) `/cart`에서 수량 변경 확인
3) `/checkout` 폼 입력 → 결제 클릭
4) `/checkout/result?mode=mock...&order_id=...`로 이동 확인
5) Supabase를 연결했다면 Table Editor에서:
   - `orders`에 row가 생성되고(mock에서) `paid`로 업데이트되는지 확인

### 5-2. Supabase 카탈로그 테스트
1) `schema.sql` 실행
2) `seed.sql` 실행(선택)
3) `.env.local`에 Supabase env 설정
4) 서버 재시작
5) `/products`에서 DB 상품이 보이는지 확인

### 5-3. “실결제 + 웹훅” 테스트(중요)
웹훅은 **공개 URL**이 필요합니다.

#### 권장: Vercel 배포 후 테스트
1) Vercel 배포
2) Vercel 환경변수 설정:
   - `NEXT_PUBLIC_SITE_URL=https://your-app.vercel.app`
   - `MERCADOPAGO_ACCESS_TOKEN=...`
   - `NEXT_PUBLIC_SUPABASE_URL=...`
   - `NEXT_PUBLIC_SUPABASE_ANON_KEY=...`
   - `SUPABASE_SERVICE_ROLE_KEY=...`
3) 실제 결제 진행
4) Supabase `orders.status`가 `pending_payment` → `paid`로 바뀌는지 확인

#### 로컬에서 테스트(ngrok 필요)
1) `ngrok http 4000`
2) 나오는 public URL을 `.env.local`의 `NEXT_PUBLIC_SITE_URL`에 넣기
3) 서버 재시작 후 결제 테스트

---

## 6) 파일/폴더 지도(중요)
- `supabase/schema.sql`: DB 스키마/RLS
- `supabase/seed.sql`: 샘플 데이터
- `src/lib/catalog.ts`: Supabase 카탈로그 로더(폴백 포함)
- `src/store/cart.ts`: 장바구니 스냅샷 저장
- `src/app/api/checkout/create-preference/route.ts`: 주문 생성 + preference 생성
- `src/app/api/mercadopago/webhook/route.ts`: 결제 웹훅 → 주문 상태 업데이트
- `src/app/api/checkout/create-pix/route.ts`: Pix 결제 생성(우리 사이트에서 QR/코드 표시)
- `src/app/login/page.tsx`: 로그인 화면
- `src/app/signup/page.tsx`: 회원가입 화면
- `src/app/account/layout.tsx`: 마이페이지 레이아웃(사이드바)
- `src/components/account/account-shell.tsx`: 마이페이지 사이드바 UI
- `src/app/account/page.tsx`: `/account` 진입 시 `/account/profile`로 이동
- `src/app/account/profile/page.tsx`: 내 정보(주소/CPF) 저장 화면
- `src/app/account/security/page.tsx`: 비밀번호 변경
- `src/app/account/orders/page.tsx`: 주문내역(진행중/히스토리) + 재구매
- `src/app/account/orders/[id]/page.tsx`: 주문 상세
- `src/lib/auth.ts`: 로그인 세션 훅
- `supabase/auth_profiles.sql`: profiles 테이블 + RLS + 신규 유저 트리거
- `supabase/orders_auth.sql`: orders.user_id + 내 주문 조회 RLS

---

## (추가) 홈 히어로 실사 이미지 교체 방법
현재 홈 히어로는 **실사 사진을 우선** 사용합니다.

1) 아래 경로에 파일을 넣으세요:
- `public/images/hero-photo.jpg`

2) 권장 스펙:
- 가로 2000px 이상(예: 2400×1600)
- 얼굴/눈/렌즈 클로즈업 또는 의료/클리닉 느낌의 인물 사진

3) 파일이 없으면 자동으로 기존 추상 이미지(SVG)로 폴백됩니다.

---

## 7) 회원가입/로그인(선택 B) — 지금 구현된 방식

### 7-1. 구현된 화면/기능
- `/signup`: 이메일/비밀번호 회원가입
- `/login`: 이메일/비밀번호 로그인
- `/account`: 마이페이지(사이드바)
  - `/account/profile`: 내 정보(주소/CPF) 저장
  - `/account/security`: 비밀번호 변경
  - `/account/orders`: 주문내역(진행중/히스토리) + 재구매
  - `/account/orders/[id]`: 주문 상세
- 헤더:
  - 비로그인: `Entrar`
  - 로그인: `Minha conta` + `Sair`

### 7-2. 체크아웃 자동입력 로직
- 로그인 상태에서 `/checkout`에 들어가면:
  - `profiles`에서 저장된 주소/CPF 등을 읽어서 **자동으로 입력칸을 채웁니다.**
- 결제 버튼을 누르면:
  - 최신 입력값을 `profiles`에 **best-effort로 업데이트**합니다.
  - 로그인 상태면 주문에 `orders.user_id`가 저장되어 “내 주문”에서 조회 가능합니다.

### 7-3. Supabase Auth 설정에서 확인할 것(운영 필수 체크)
Supabase Dashboard → Authentication → Settings에서:
- Email auth 활성화
- (옵션) Email confirmation(인증메일) 켜기/끄기 결정
  - 켜면: 회원가입 후 이메일 인증해야 로그인 가능
  - 끄면: 바로 로그인 가능(테스트는 편함)

> 운영에서는 스팸/계정 안전을 위해 보통 “이메일 인증”을 켜는 편이지만,
> 초기 런칭 전환율을 우선하면 꺼둘 수도 있습니다. (사업 판단)

---

## 8) Pix / Cartão 결제 테스트(현재 구현)

### 8-1. 공통 전제
- `.env.local`에 `MERCADOPAGO_ACCESS_TOKEN`이 **반드시** 있어야 실제 결제가 됩니다.
- 없으면(빈 값이면) 결제는 “테스트 흐름”만 가능하고, Pix QR/PG 리다이렉트는 동작하지 않습니다.

### 8-2. Pix(우리 사이트에서 QR/코드 표시)
Checkout에서 결제수단을 **Pix(QR Code)**로 선택하면:
- 서버가 Mercado Pago Payments API로 Pix 결제를 생성
- 화면에 QR 코드 + 복사코드가 표시됩니다.

테스트 절차:
- `/checkout` → Pix 선택 → “Gerar Pix …”
- QR이 나오면 성공
- Supabase `orders`에서 `mp_payment_id`가 채워지는지 확인

주의(상용 운영):
- 현재는 “주문 생성 시 재고를 예약(차감)”하는 방식이라,
  결제가 오래 미완료로 남으면 재고가 묶일 수 있습니다.
  운영 단계에서는 “유효시간/타임아웃 후 자동 복구” 정책을 추가하는 것을 추천합니다.

### 8-3. Cartão(Checkout Pro로 리다이렉트)
Checkout에서 결제수단을 **Cartão**로 선택하면:
- Checkout Pro로 리다이렉트되어 카드 결제 UI가 진행됩니다.

테스트 절차:
- `/checkout` → Cartão 선택 → “Pagar …”
- 결제 페이지로 이동하면 성공
- 결제 완료 후 back_urls로 `/checkout/result`로 돌아옵니다.

---

## 9) 마이페이지(상용화) 테스트 방법

### 9-1. 준비(중요)
마이페이지에서 “내 주문”이 보이려면, Supabase에 아래 SQL이 적용되어야 합니다:
- `supabase/orders_auth.sql`

### 9-2. 테스트 시나리오(추천)
1) `/signup` → 가입
2) `/login` → 로그인
3) `/account/profile`에서 주소 저장
4) 상품을 담고 `/checkout`에서 결제 진행(Pix 생성 또는 카드 결제)
   - 로그인 상태면 주문에 `user_id`가 저장됩니다.
5) `/account/orders`에서:
   - “Em andamento”(진행중) / “Histórico”(히스토리) 목록이 보이는지 확인
6) 주문 상세(`/account/orders/[id]`)에서:
   - 아이템 목록 확인
   - “Recomprar” 버튼으로 장바구니에 담기는지 확인



## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.
